<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
		Remove this if you use the .htaccess -->
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<title>Space</title>
		<meta name="description" content="" />
		
		<meta name="viewport" content="width=device-width; initial-scale=1.0" />
		<!-- Replace favicon.ico & apple-touch-icon.png in the root of your domain and delete these references -->
		<link rel="shortcut icon" href="/favicon.ico" />
		<link rel="apple-touch-icon" href="/apple-touch-icon.png" />
		
		<script src="js/jquery.js"></script>
		
		<script src="js/draw.js"></script>
		<script src="js/calcs.js"></script>
		
		<script src="game.js"></script>
		
		<script>
		
			$(function(){
				var canvas = $('#le-canvas');
				
			})
			
			window.onload = function() {
				// This works better/less buggy than document.ready when working with the canvas
				
				var ctx = contextFactory.getContext('le-canvas');
				
				game.playerShip = new game.Ship(100, 100, 37, 81);
				game.playerShip.sprite = new game.Sprite("imgs/sprites/razor1.png" ,game.playerShip.x, game.playerShip.y, 1);
				
				// Main loop
				setInterval(function(){
					
					ctx.clearRect(0, 0, 800, 600)
					
					ctx.save();
					
					updateViewPort();
					
					ctx.translate(-game.ViewPort.x, -game.ViewPort.y)
				
					if (game.playerShip.turningLeft) {
						game.playerShip.heading -= 15 * Math.PI/180;
					};
					
					if (game.playerShip.turningRight) {
						game.playerShip.heading += 15 * Math.PI/180;
					};
					
					var decay = 0.95;
					
					if (game.playerShip.thrustersOn && Math.abs(game.playerShip.dx) < game.playerShip.maxSpeed) {
						game.playerShip.dx += 1 * Math.cos(game.playerShip.heading);
						game.playerShip.dy += 1 * Math.sin(game.playerShip.heading);
					} else {
						game.playerShip.dx *= decay;
						game.playerShip.dy *= decay;
					};
					
					checkBounds();
					
					game.playerShip.x += game.playerShip.dx; // If we multiply here by the cos instead, the ship feels easier to fly yet clunky
					game.playerShip.y += game.playerShip.dy;
					
					var bg = new game.Sprite('imgs/bg.png', 0, 0, 800, 600, -1);
					bg.render(ctx);
					
					game.playerShip.render(ctx);
					
					ctx.restore();
					
				}, 1000/24)
				//alert(iso.alpha)
				
			}
			$(document).keydown(function(event)
			{
			  var keyCode;
			  //alert('??')
			  if(event == null)
			    keyCode = window.event.keyCode;
			  else
			    keyCode = event.keyCode;
			
			  switch(keyCode)
			  {
			    // left
			    case 37:
			      game.playerShip.turningLeft = true;
			      break;
			    // up
			    case 38:
			      game.playerShip.thrustersOn = true;
			      break;
			    // right
			    case 39:
			      game.playerShip.turningRight = true;
			      break;
			    // down
			    case 40:
			      addForceToAllBlobs(new Vector(0.0, 50.0));
			      break;
			  }
			})
			
			$(document).keyup(function(event)
			{
			  var keyCode;
			  //alert('??')
			  if(event == null)
			    keyCode = window.event.keyCode;
			  else
			    keyCode = event.keyCode;
			
			  switch(keyCode)
			  {
			    // left
			    case 37:
			      game.playerShip.turningLeft = false;
			      break;
			    // up
			    case 38:
			      game.playerShip.thrustersOn = false;
			      break;
			    // right
			    case 39:
			      game.playerShip.turningRight = false;
			      break;
			    // down
			    case 40:
			      addForceToAllBlobs(new Vector(0.0, 50.0));
			      break;
			  }
			})
			
			renderer = {};
			renderer.pipeline = [];
			renderer.renderFrame = function(ctx){
				renderer.pipeline.sort(function(a, b){ return a.depth-b.depth; })
				
				for (var i=0; i < renderer.pipeline.length; i++) {
			  		var sprite = renderer.pipeline[i];
			  		sprite.render(ctx);
				};
				
				renderer.pipeline = [];
			}
			
			checkBounds = function() {
				
					
				if (game.playerShip.x > 1244) {
					game.playerShip.dx = 0;
					game.playerShip.x = 1243;
				}
				
				if (game.playerShip.x < 0) {
					game.playerShip.dx = 0;
					game.playerShip.x = 10;
				}
				
				if (game.playerShip.y > 980) {
					game.playerShip.dy = 0;
					game.playerShip.y = 979;
				}
				
				if (game.playerShip.y < 0) {
					game.playerShip.dy = 0;
					game.playerShip.y = 20;
				}
			}
			
			updateViewPort = function() {
				game.ViewPort.x = game.playerShip.x - (game.ViewPort.width/2);
				game.ViewPort.y = game.playerShip.y - (game.ViewPort.height/2);
				
				if (game.ViewPort.x > 1244 - game.ViewPort.width) {
					game.ViewPort.x = 1244 - game.ViewPort.width;
				};
				
				if (game.ViewPort.x < 0) {
					game.ViewPort.x = 0;
				};
				
				if (game.ViewPort.y > 980 - game.ViewPort.height) {
					game.ViewPort.y = 980 - game.ViewPort.height;
				};
				
				if (game.ViewPort.y < 0) {
					game.ViewPort.y = 0;
				};
				
			}
			
		</script>
		
		<style>
			#le-canvas
			{
				background-color: #F1F2F3;
				background-image: url('imgs/bg.png');
			}
		</style>
		
	</head>
	<body>
		<div>
			
			
			<img src="imgs/sprites/razor1.png" />
			
			
			<canvas id="le-canvas" width="800" height="600">
				Fallback content
			</canvas>
			
		</div>
	</body>
</html>